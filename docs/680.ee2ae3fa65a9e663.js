"use strict";(self.webpackChunkphoenix_for_ild=self.webpackChunkphoenix_for_ild||[]).push([[680],{680:(O,R,u)=>{u.r(R),u.d(R,{TASImagePainter:()=>B});var b=u(467),g=u(6998),x=u(6823),p=u(6370),v=u(9041),A=u(6224),E=u(4485),w=u(9025);class B extends A.JW{decodeOptions(a){const t=new v.nC(a);this.options={Zscale:!1};const e=this.getObject();t.check("CONST")&&(this.options.constRatio=!0,e&&(e.fConstRatio=!0),console.log("use const")),t.check("Z")&&(this.options.Zscale=!0)}createRGBA(a){const t=this.getObject(),e=t?.fPalette;if(!e)return null;const r=new Array(4*(a+1)).fill(0);for(let s=0,o=1;s<=a;++s){const n=s/a;for(;e.fPoints[o]<n&&o<e.fPoints.length-1;)o++;const l=(e.fPoints[o]-n)/(e.fPoints[o]-e.fPoints[o-1]),i=(n-e.fPoints[o-1])/(e.fPoints[o]-e.fPoints[o-1]);r[4*s]=Math.min(255,Math.round((e.fColorRed[o-1]*l+e.fColorRed[o]*i)/256)),r[4*s+1]=Math.min(255,Math.round((e.fColorGreen[o-1]*l+e.fColorGreen[o]*i)/256)),r[4*s+2]=Math.min(255,Math.round((e.fColorBlue[o-1]*l+e.fColorBlue[o]*i)/256)),r[4*s+3]=Math.min(255,Math.round((e.fColorAlpha[o-1]*l+e.fColorAlpha[o]*i)/256))}return r}makeUrlFromImageBuf(a,t){var e=this;return(0,b.A)(function*(){e.rgba=e.createRGBA(1e3);let s=a.fImgBuf[0],o=a.fImgBuf[0];for(let i=1;i<a.fImgBuf.length;++i){const f=a.fImgBuf[i];s=Math.min(f,s),o=Math.max(f,o)}e.fContour={arr:new Array(200),rgba:e.rgba,getLevels(){return this.arr},getPaletteColor(i,f){if(!this.arr||!this.rgba)return"white";const c=4*Math.round((f-this.arr[0])/(this.arr[this.arr.length-1]-this.arr[0])*(this.rgba.length-4)/4);return"#"+(0,x.nj)(this.rgba[c],1)+(0,x.nj)(this.rgba[c+1],1)+(0,x.nj)(this.rgba[c+2],1)+(0,x.nj)(this.rgba[c+3],1)}};for(let i=0;i<200;i++)e.fContour.arr[i]=s+(o-s)/199*i;s>=o&&(o=s+1);const n=e.getImageZoomRange(t,a.fConstRatio,a.fWidth,a.fHeight);return((0,g.isNodeJs)()?u.e(965).then(u.t.bind(u,1965,19)).then(i=>i.default.createCanvas(n.xmax-n.xmin,n.ymax-n.ymin)):new Promise(i=>{const f=document.createElement("canvas");f.width=n.xmax-n.xmin,f.height=n.ymax-n.ymin,i(f)})).then(i=>{const f=i.getContext("2d"),c=f.getImageData(0,0,i.width,i.height),h=c.data;for(let m=n.ymin;m<n.ymax;++m){let d=(n.ymax-m-1)*(n.xmax-n.xmin)*4;const C=m*a.fWidth;for(let P=n.xmin;P<n.xmax;++P){let _=4*Math.round((a.fImgBuf[C+P]-s)/(o-s)*1e3);h[d++]=e.rgba[_++],h[d++]=e.rgba[_++],h[d++]=e.rgba[_++],h[d++]=e.rgba[_++]}}return f.putImageData(c,0,0),{url:i.toDataURL(),constRatio:a.fConstRatio,can_zoom:!0}})})()}getImageZoomRange(a,t,e,r){const s={xmin:0,xmax:e,ymin:0,ymax:r};if(!a)return s;let o=0,n=0,l=e,i=r;if(t){const f=r/e,c=a.getFrameHeight()/a.getFrameWidth();if(f>c){const h=r/c;o=Math.round((h-e)/2),l=Math.round(h)}else{const h=c*e;n=Math.round((h-r)/2),i=Math.round(h)}}return a.zoom_xmin!==a.zoom_xmax&&(s.xmin=Math.min(e,Math.max(0,Math.round(a.zoom_xmin*l)-o)),s.xmax=Math.min(e,Math.max(0,Math.round(a.zoom_xmax*l)-o))),a.zoom_ymin!==a.zoom_ymax&&(s.ymin=Math.min(r,Math.max(0,Math.round(a.zoom_ymin*i)-n)),s.ymax=Math.min(r,Math.max(0,Math.round(a.zoom_ymax*i)-n))),s}makeUrlFromPngBuf(a,t){var e=this;return(0,b.A)(function*(){const r=a.fPngBuf;let s="";if((0,g.isStr)(r))s=r;else for(let l=0;l<r.length;++l)s+=String.fromCharCode(r[l]<0?256+r[l]:r[l]);const o={url:"data:image/png;base64,"+(0,g.btoa_func)(s),constRatio:a.fConstRatio,can_zoom:t&&!(0,g.isNodeJs)()},n=(0,g.getDocument)();return!o.can_zoom||t?.zoom_xmin===t?.zoom_xmax&&t?.zoom_ymin===t?.zoom_ymax?o:new Promise(l=>{const i=n.createElement("img");i.onload=()=>{const f=n.createElement("canvas");f.width=i.width,f.height=i.height;const c=f.getContext("2d");c.drawImage(i,0,0);const h=c.getImageData(0,0,i.width,i.height).data,m=e.getImageZoomRange(t,o.constRatio,i.width,i.height),d=n.createElement("canvas");d.width=m.xmax-m.xmin,d.height=m.ymax-m.ymin;const C=d.getContext("2d"),P=C.getImageData(0,0,d.width,d.height),_=P.data;for(let M=m.ymin;M<m.ymax;++M){let I=(m.ymax-M-1)*(m.xmax-m.xmin)*4,D=4*((i.height-M-1)*i.width+m.xmin);for(let y=m.xmin;y<m.xmax;++y)_[I++]=h[D++],_[I++]=h[D++],_[I++]=h[D++],_[I++]=h[D++]}C.putImageData(P,0,0),o.url=d.toDataURL(),l(o)},i.onerror=()=>l(o),i.src=o.url})})()}drawImage(){var a=this;return(0,b.A)(function*(){const t=a.getObject(),e=a.getFramePainter(),r=e?.getFrameRect()??a.getPadPainter().getPadRect();let s;return a.wheel_zoomy=!0,t._blob&&(15!==t._blob.length||t._blob[0]?3===t._blob.length&&t._blob[0]?(t.fPngBuf=t._blob[2],t.fPngBuf?.length!==t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${t.fPngBuf?.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`):(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:g.clTImagePalette,fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!==t.fImgBuf.length||t.fPalette.fNumPoints!==t.fPalette.fPoints.length)&&(console.error(`TASImage _blob decoding error ${t.fWidth*t.fHeight} != ${t.fImgBuf.length} ${t.fPalette.fNumPoints} != ${t.fPalette.fPoints.length}`),delete t.fImgBuf,delete t.fPalette)),delete t._blob),s=t.fImgBuf&&t.fPalette?a.makeUrlFromImageBuf(t,e):t.fPngBuf?a.makeUrlFromPngBuf(t,e):Promise.resolve(null),s.then(o=>{if(!o?.url)return a;const n=a.createG(!!e).append("image").attr("href",o.url).attr("width",r.width).attr("height",r.height).attr("preserveAspectRatio",o.constRatio?null:"none");return a.isBatchMode()||((g.settings.MoveResize||g.settings.ContextMenu)&&n.style("pointer-events","visibleFill"),o.can_zoom&&n.style("cursor","pointer")),(0,p.wh)(a),e&&o.can_zoom?a.drawColorPalette(a.options.Zscale,!0).then(()=>(e.setAxesRanges((0,g.create)(g.clTAxis),0,1,(0,g.create)(g.clTAxis),0,1,null,0,0),e.createXY({ndim:2,check_pad_range:!1}),e.addInteractivity())):a})})()}fillContextMenuItems(a){const t=this.getObject();t&&a.addchk(t.fConstRatio,"Const ratio",e=>{t.fConstRatio=e,this.interactiveRedraw("pad",`exec:SetConstRatio(${e})`)},"Change const ratio flag of image"),t?.fPalette&&a.addchk(this.options.Zscale,"Color palette",e=>{this.options.Zscale=e,this.drawColorPalette(e,!0)},"Toggle color palette")}canZoomInside(a,t,e){return!!this.getObject()&&("x"===a||"y"===a)&&e-t>.01}drawColorPalette(a,t){var e=this;return(0,b.A)(function*(){if(!e.isMainPainter())return null;if(!e.draw_palette){const n=(0,g.create)(g.clTPaletteAxis);Object.assign(n,{fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),n.fAxis.fChopt="+",e.draw_palette=n,e._color_palette=!0}let r=e.getPadPainter().findPainterFor(e.draw_palette);if(!a)return r&&(r.Enabled=!1,r.removeG()),null;const s=e.getFramePainter();if(t&&s){const n=e.draw_palette;n.fX2NDC=s.fX2NDC+.01+(n.fX2NDC-n.fX1NDC),n.fX1NDC=s.fX2NDC+.01,n.fY1NDC=s.fY1NDC,n.fY2NDC=s.fY2NDC}if(r)return r.Enabled=!0,r.drawPave("");const o=e.selectCurrentPad(e.getPadName());return E.TPavePainter.draw(e.getDom(),e.draw_palette).then(n=>{r=n,e.selectCurrentPad(o),r.setSecondary(e),r.redraw=function(){}})})()}toggleColz(){if(this.getObject()?.fPalette)return this.options.Zscale=!this.options.Zscale,this.drawColorPalette(this.options.Zscale,!0)}redraw(){return this.drawImage()}clickButton(a){return!(!this.isMainPainter()||"ToggleColorZ"!==a)&&this.toggleColz()}fillToolbar(){const a=this.getPadPainter();a&&this.getObject()?.fPalette&&(a.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),a.showPadButtons())}static draw(a,t,e){return(0,b.A)(function*(){const r=new B(a,t,e);return r.setAsMainPainter(),r.decodeOptions(e),(0,w.ensureTCanvas)(r,!1).then(()=>r.drawImage()).then(()=>(r.fillToolbar(),r))})()}}}}]);