"use strict";(self.webpackChunkphoenix_for_ild=self.webpackChunkphoenix_for_ild||[]).push([[680],{680:(O,R,u)=>{u.r(R),u.d(R,{TASImagePainter:()=>B});var b=u(467),g=u(6998),x=u(6823),p=u(6370),v=u(9041),A=u(6224),w=u(4485),E=u(9025);class B extends A.JW{decodeOptions(o){const t=new v.nC(o);this.options={Zscale:!1};const e=this.getObject();t.check("CONST")&&(this.options.constRatio=!0,e&&(e.fConstRatio=!0),console.log("use const")),t.check("Z")&&(this.options.Zscale=!0)}createRGBA(o){const t=this.getObject(),e=t?.fPalette;if(!e)return null;const r=new Array(4*(o+1)).fill(0);for(let l=0,a=1;l<=o;++l){const n=l/o;for(;e.fPoints[a]<n&&a<e.fPoints.length-1;)a++;const s=(e.fPoints[a]-n)/(e.fPoints[a]-e.fPoints[a-1]),i=(n-e.fPoints[a-1])/(e.fPoints[a]-e.fPoints[a-1]);r[4*l]=Math.min(255,Math.round((e.fColorRed[a-1]*s+e.fColorRed[a]*i)/256)),r[4*l+1]=Math.min(255,Math.round((e.fColorGreen[a-1]*s+e.fColorGreen[a]*i)/256)),r[4*l+2]=Math.min(255,Math.round((e.fColorBlue[a-1]*s+e.fColorBlue[a]*i)/256)),r[4*l+3]=Math.min(255,Math.round((e.fColorAlpha[a-1]*s+e.fColorAlpha[a]*i)/256))}return r}makeUrlFromImageBuf(o,t){var e=this;return(0,b.A)(function*(){e.rgba=e.createRGBA(1e3);let l=o.fImgBuf[0],a=o.fImgBuf[0];for(let i=1;i<o.fImgBuf.length;++i){const f=o.fImgBuf[i];l=Math.min(f,l),a=Math.max(f,a)}e.fContour={arr:new Array(200),rgba:e.rgba,getLevels(){return this.arr},getPaletteColor(i,f){if(!this.arr||!this.rgba)return"white";const c=4*Math.round((f-this.arr[0])/(this.arr[this.arr.length-1]-this.arr[0])*(this.rgba.length-4)/4);return"#"+(0,x.nj)(this.rgba[c],1)+(0,x.nj)(this.rgba[c+1],1)+(0,x.nj)(this.rgba[c+2],1)+(0,x.nj)(this.rgba[c+3],1)}};for(let i=0;i<200;i++)e.fContour.arr[i]=l+(a-l)/199*i;l>=a&&(a=l+1);const n=e.getImageZoomRange(t,o.fConstRatio,o.fWidth,o.fHeight);return((0,g.isNodeJs)()?u.e(965).then(u.t.bind(u,1965,19)).then(i=>i.default.createCanvas(n.xmax-n.xmin,n.ymax-n.ymin)):new Promise(i=>{const f=document.createElement("canvas");f.width=n.xmax-n.xmin,f.height=n.ymax-n.ymin,i(f)})).then(i=>{const f=i.getContext("2d"),c=f.getImageData(0,0,i.width,i.height),h=c.data;for(let m=n.ymin;m<n.ymax;++m){let d=(n.ymax-m-1)*(n.xmax-n.xmin)*4;const C=m*o.fWidth;for(let P=n.xmin;P<n.xmax;++P){let _=4*Math.round((o.fImgBuf[C+P]-l)/(a-l)*1e3);h[d++]=e.rgba[_++],h[d++]=e.rgba[_++],h[d++]=e.rgba[_++],h[d++]=e.rgba[_++]}}return f.putImageData(c,0,0),{url:i.toDataURL(),constRatio:o.fConstRatio,can_zoom:!0}})})()}getImageZoomRange(o,t,e,r){const l={xmin:0,xmax:e,ymin:0,ymax:r};if(!o)return l;let a=0,n=0,s=e,i=r;if(t){const f=r/e,c=o.getFrameHeight()/o.getFrameWidth();if(f>c){const h=r/c;a=Math.round((h-e)/2),s=Math.round(h)}else{const h=c*e;n=Math.round((h-r)/2),i=Math.round(h)}}return o.zoom_xmin!==o.zoom_xmax&&(l.xmin=Math.min(e,Math.max(0,Math.round(o.zoom_xmin*s)-a)),l.xmax=Math.min(e,Math.max(0,Math.round(o.zoom_xmax*s)-a))),o.zoom_ymin!==o.zoom_ymax&&(l.ymin=Math.min(r,Math.max(0,Math.round(o.zoom_ymin*i)-n)),l.ymax=Math.min(r,Math.max(0,Math.round(o.zoom_ymax*i)-n))),l}makeUrlFromPngBuf(o,t){var e=this;return(0,b.A)(function*(){const r=o.fPngBuf;let l="";if((0,g.isStr)(r))l=r;else for(let s=0;s<r.length;++s)l+=String.fromCharCode(r[s]<0?256+r[s]:r[s]);const a={url:"data:image/png;base64,"+(0,g.btoa_func)(l),constRatio:o.fConstRatio,can_zoom:t&&!(0,g.isNodeJs)()},n=(0,g.getDocument)();return!a.can_zoom||t?.zoom_xmin===t?.zoom_xmax&&t?.zoom_ymin===t?.zoom_ymax?a:new Promise(s=>{const i=n.createElement("img");i.onload=()=>{const f=n.createElement("canvas");f.width=i.width,f.height=i.height;const c=f.getContext("2d");c.drawImage(i,0,0);const h=c.getImageData(0,0,i.width,i.height).data,m=e.getImageZoomRange(t,a.constRatio,i.width,i.height),d=n.createElement("canvas");d.width=m.xmax-m.xmin,d.height=m.ymax-m.ymin;const C=d.getContext("2d"),P=C.getImageData(0,0,d.width,d.height),_=P.data;for(let M=m.ymin;M<m.ymax;++M){let I=(m.ymax-M-1)*(m.xmax-m.xmin)*4,D=4*((i.height-M-1)*i.width+m.xmin);for(let y=m.xmin;y<m.xmax;++y)_[I++]=h[D++],_[I++]=h[D++],_[I++]=h[D++],_[I++]=h[D++]}C.putImageData(P,0,0),a.url=d.toDataURL(),s(a)},i.onerror=()=>s(a),i.src=a.url})})()}drawImage(){var o=this;return(0,b.A)(function*(){const t=o.getObject(),e=o.getFramePainter(),r=e?.getFrameRect()??o.getPadPainter().getPadRect();let l;return o.wheel_zoomy=!0,t._blob&&(15!==t._blob.length||t._blob[0]?3===t._blob.length&&t._blob[0]?(t.fPngBuf=t._blob[2],t.fPngBuf?.length!==t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${t.fPngBuf?.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`):(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:g.clTImagePalette,fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!==t.fImgBuf.length||t.fPalette.fNumPoints!==t.fPalette.fPoints.length)&&(console.error(`TASImage _blob decoding error ${t.fWidth*t.fHeight} != ${t.fImgBuf.length} ${t.fPalette.fNumPoints} != ${t.fPalette.fPoints.length}`),delete t.fImgBuf,delete t.fPalette)),delete t._blob),l=t.fImgBuf&&t.fPalette?o.makeUrlFromImageBuf(t,e):t.fPngBuf?o.makeUrlFromPngBuf(t,e):Promise.resolve(null),l.then(a=>{if(!a?.url)return o;const n=o.createG(!!e).append("image").attr("href",a.url).attr("width",r.width).attr("height",r.height).attr("preserveAspectRatio",a.constRatio?null:"none");return o.isBatchMode()||((g.settings.MoveResize||g.settings.ContextMenu)&&n.style("pointer-events","visibleFill"),a.can_zoom&&n.style("cursor","pointer")),(0,p.wh)(o),e&&a.can_zoom?o.drawColorPalette(o.options.Zscale,!0).then(()=>(e.setAxesRanges((0,g.create)(g.clTAxis),0,1,(0,g.create)(g.clTAxis),0,1,null,0,0),e.createXY({ndim:2,check_pad_range:!1}),e.addInteractivity())):o})})()}fillContextMenuItems(o){const t=this.getObject();t&&o.addchk(t.fConstRatio,"Const ratio",e=>{t.fConstRatio=e,this.interactiveRedraw("pad",`exec:SetConstRatio(${e})`)},"Change const ratio flag of image"),t?.fPalette&&o.addchk(this.options.Zscale,"Color palette",e=>{this.options.Zscale=e,this.drawColorPalette(e,!0)},"Toggle color palette")}canZoomInside(o,t,e){return!!this.getObject()&&("x"===o||"y"===o)&&e-t>.01}drawColorPalette(o,t){var e=this;return(0,b.A)(function*(){if(!e.isMainPainter())return null;if(!e.draw_palette){const n=(0,g.create)(g.clTPaletteAxis);Object.assign(n,{fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),n.fAxis.fChopt="+",e.draw_palette=n,e._color_palette=!0}let r=e.getPadPainter().findPainterFor(e.draw_palette);if(!o)return r&&(r.Enabled=!1,r.removeG()),null;const l=e.getFramePainter();if(t&&l){const n=e.draw_palette;n.fX2NDC=l.fX2NDC+.01+(n.fX2NDC-n.fX1NDC),n.fX1NDC=l.fX2NDC+.01,n.fY1NDC=l.fY1NDC,n.fY2NDC=l.fY2NDC}if(r)return r.Enabled=!0,r.drawPave("");const a=e.selectCurrentPad(e.getPadName());return w.TPavePainter.draw(e.getDom(),e.draw_palette).then(n=>{r=n,e.selectCurrentPad(a),r.setSecondary(e),r.redraw=function(){}})})()}toggleColz(){if(this.getObject()?.fPalette)return this.options.Zscale=!this.options.Zscale,this.drawColorPalette(this.options.Zscale,!0)}redraw(){return this.drawImage()}clickButton(o){return!(!this.isMainPainter()||"ToggleColorZ"!==o)&&this.toggleColz()}fillToolbar(){const o=this.getPadPainter();o&&this.getObject()?.fPalette&&(o.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),o.showPadButtons())}static draw(o,t,e){return(0,b.A)(function*(){const r=new B(o,t,e);return r.setAsMainPainter(),r.decodeOptions(e),(0,E.ensureTCanvas)(r,!1).then(()=>r.drawImage()).then(()=>(r.fillToolbar(),r))})()}}}}]);