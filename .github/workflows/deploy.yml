name: deploy

on:
  push:

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build-app:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v3
      with: 
        node-version: 20.16.0
    - uses: borales/actions-yarn@v4
      with: 
        cmd: install
    - name: install angular
      run: npm install -g @angular/cli@17
    - name: build app
      run: ng build --output-path ild-phoenix-app --base-href /Phoenix-ILD/

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ild-phoenix-app

  publish-doc:
    needs: build-app
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
      - name: remove build file
        run: rm -rf $GITHUB_WORKSPACE/*
      - uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: doc_artifact

      - name: update build file
        run: |
          tar -xvf doc_artifact/artifact.tar --directory ${GITHUB_WORKSPACE}
          rm -r doc_artifact
          
      - name: commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email ${GITHUB_ACTOR_ID}+${GITHUB_ACTOR}@users.noreply.github.com
          git config --global user.name ${GITHUB_ACTOR}
          git add .
          git diff-index --quiet HEAD 2>&1 > /dev/null || git commit -m "Update build files for Phoenix-ILD" && git push